<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClawID - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-page: #09090b;
      --bg-card: #18181b;
      --bg-elevated: #27272a;
      --bg-input: #0f0f12;
      --primary: #10b981;
      --primary-muted: #059669;
      --primary-glow: rgba(16, 185, 129, 0.15);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --border: #27272a;
      --border-hover: #3f3f46;
      --font-sans: 'Inter', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }
    body { font-family: var(--font-sans); background: var(--bg-page); color: var(--text-primary); min-height: 100vh; }

    /* Auth Screen */
    .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .auth-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 2.5rem; width: 100%; max-width: 400px; }
    .auth-logo { display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 2rem; }
    .auth-logo img { width: 48px; height: 48px; border-radius: 12px; }
    .auth-logo-text { font-size: 1.5rem; font-weight: 700; }
    .auth-title { text-align: center; font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
    .auth-subtitle { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 2rem; }
    .auth-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
    .auth-tab { flex: 1; padding: 0.75rem; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.15s ease; font-family: var(--font-sans); }
    .auth-tab.active { background: var(--primary); border-color: var(--primary); color: var(--bg-page); }
    .auth-tab:hover:not(.active) { background: var(--border); color: var(--text-primary); }
    .auth-form { display: flex; flex-direction: column; gap: 1rem; }
    .auth-input { width: 100%; padding: 0.875rem 1rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: var(--font-sans); font-size: 0.95rem; transition: border-color 0.15s ease; }
    .auth-input:focus { outline: none; border-color: var(--primary); }
    .auth-input::placeholder { color: var(--text-muted); }
    .auth-btn { width: 100%; padding: 0.875rem; background: var(--primary); border: none; border-radius: 8px; color: var(--bg-page); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: background 0.15s ease; font-family: var(--font-sans); }
    .auth-btn:hover { background: var(--primary-muted); }
    .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .auth-error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); border-radius: 8px; padding: 0.75rem 1rem; color: var(--error); font-size: 0.85rem; display: none; }
    .auth-error.show { display: block; }
    .auth-divider { display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; color: var(--text-muted); font-size: 0.8rem; }
    .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .claim-section { background: var(--bg-elevated); border-radius: 8px; padding: 1rem; }
    .claim-section label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .claim-section small { display: block; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }

    /* Dashboard styles */
    .dashboard { display: none; }
    .dashboard.active { display: block; }
    .auth-screen { display: block; }
    .auth-screen.hidden { display: none; }

    .sidebar { position: fixed; left: 0; top: 0; width: 240px; height: 100vh; background: var(--bg-card); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 100; }
    .logo { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem; }
    .logo img { width: 36px; height: 36px; border-radius: 10px; }
    .logo-text { font-weight: 600; font-size: 1.1rem; }
    .nav { display: flex; flex-direction: column; gap: 0.25rem; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 0.75rem; border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; transition: all 0.15s ease; cursor: pointer; }
    .nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .nav-item.active { background: var(--primary-glow); color: var(--primary); }
    .nav-icon { width: 20px; text-align: center; }
    .nav-section { margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); padding-left: 0.75rem; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border); }
    .user-info { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; margin-bottom: 0.75rem; }
    .user-avatar { width: 32px; height: 32px; background: var(--primary-glow); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
    .user-email { font-size: 0.8rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .logout-btn { width: 100%; padding: 0.5rem 0.75rem; background: transparent; border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; transition: all 0.15s ease; font-family: var(--font-sans); }
    .logout-btn:hover { background: var(--bg-elevated); color: var(--error); border-color: var(--error); }

    .main { margin-left: 240px; padding: 2rem 3rem; min-height: 100vh; }
    .page-header { margin-bottom: 2rem; }
    .page-title { font-size: 1.75rem; font-weight: 600; margin-bottom: 0.5rem; }
    .page-subtitle { color: var(--text-secondary); font-size: 0.95rem; }

    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; }
    .stat-value { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.15rem; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); }

    .table-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .table-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
    .table-title { font-weight: 600; font-size: 0.9rem; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 0.5rem 1rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 500; border-bottom: 1px solid var(--border); }
    td { padding: 0.5rem 1rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    .agent-cell { display: flex; align-items: center; gap: 0.5rem; }
    .agent-avatar { width: 24px; height: 24px; border-radius: 6px; background: var(--bg-elevated); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; }
    .agent-name { font-weight: 500; font-size: 0.85rem; white-space: nowrap; }
    .did-cell { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-secondary); }
    .rep-cell { display: flex; align-items: center; gap: 0.4rem; }
    .rep-bar { width: 50px; height: 4px; background: var(--bg-elevated); border-radius: 2px; overflow: hidden; }
    .rep-fill { height: 100%; background: var(--primary); border-radius: 2px; }
    .rep-score { font-size: 0.8rem; }
    .status-badge { display: inline-flex; padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 500; }
    .status-badge.main { background: rgba(59, 130, 246, 0.15); color: var(--info); }
    .status-badge.worker { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .empty-state { text-align: center; padding: 2rem 1rem; color: var(--text-muted); font-size: 0.9rem; }

    .claim-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; }
    .claim-card h3 { font-size: 0.9rem; margin-bottom: 0.35rem; }
    .claim-card p { color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.75rem; }
    .claim-form { display: flex; gap: 0.5rem; }
    .claim-form input { flex: 1; max-width: 150px; padding: 0.5rem 0.75rem; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: var(--font-mono); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; }
    .claim-form input:focus { outline: none; border-color: var(--primary); }
    .claim-form button { padding: 0.5rem 1rem; background: var(--primary); border: none; border-radius: 6px; color: var(--bg-page); font-weight: 600; cursor: pointer; font-family: var(--font-sans); font-size: 0.85rem; }
    .claim-form button:hover { background: var(--primary-muted); }
    .claim-result { margin-top: 0.75rem; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.8rem; display: none; }
    .claim-result.success { display: block; background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success); color: var(--success); }
    .claim-result.error { display: block; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); color: var(--error); }

    /* Mobile */
    .hamburger { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 200; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; cursor: pointer; }
    .hamburger span { display: block; width: 20px; height: 2px; background: var(--text-primary); margin: 4px 0; }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 90; }
    
    @media (max-width: 768px) {
      .hamburger { display: block; }
      .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.active { display: block; }
      .main { margin-left: 0; padding: 1.5rem 1rem; padding-top: 5rem; }
      .stats-grid { grid-template-columns: 1fr; }
      .auth-card { padding: 1.5rem; }
    }

    .toast-container { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000; }
    .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--error); }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-logo">
          <img src="/logo.jpg" alt="ClawID" onerror="this.style.display='none'">
          <span class="auth-logo-text">ClawID</span>
        </div>
        <h1 class="auth-title">Welcome</h1>
        <p class="auth-subtitle">Sign in to manage your AI agents</p>
        
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="showAuthTab('signin')">Sign In</button>
          <button class="auth-tab" onclick="showAuthTab('signup')">Sign Up</button>
        </div>

        <div class="auth-error" id="auth-error"></div>

        <form class="auth-form" id="signin-form" onsubmit="handleSignIn(event)">
          <input type="email" class="auth-input" placeholder="Email" required id="signin-email">
          <input type="password" class="auth-input" placeholder="Password" required id="signin-password">
          <button type="submit" class="auth-btn" id="signin-btn">Sign In</button>
        </form>

        <form class="auth-form" id="signup-form" style="display:none" onsubmit="handleSignUp(event)">
          <input type="email" class="auth-input" placeholder="Email" required id="signup-email">
          <input type="password" class="auth-input" placeholder="Password (min 6 chars)" required id="signup-password" minlength="6">
          <button type="submit" class="auth-btn" id="signup-btn">Create Account</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <button class="hamburger" onclick="toggleSidebar()">
      <span></span><span></span><span></span>
    </button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
      <div class="logo">
        <img src="/logo.jpg" alt="ClawID" onerror="this.style.display='none'">
        <span class="logo-text">ClawID</span>
      </div>
      <nav class="nav">
        <a class="nav-item active"><span class="nav-icon">üìä</span><span>My Agents</span></a>
        <a class="nav-item" href="/"><span class="nav-icon">üè†</span><span>Home</span></a>
        <div class="nav-section">Help</div>
        <a class="nav-item" href="https://github.com/USSU123/agent-identity-layer" target="_blank"><span class="nav-icon">üìñ</span><span>Documentation</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar">üë§</div>
          <span class="user-email" id="user-email">user@example.com</span>
        </div>
        <button class="logout-btn" onclick="handleSignOut()">Sign Out</button>
      </div>
    </aside>

    <main class="main">
      <header class="page-header">
        <h1 class="page-title">My Agents</h1>
        <p class="page-subtitle">Manage your AI agent identities</p>
      </header>

      <div class="claim-card">
        <h3>üîó Claim an Agent</h3>
        <p>Enter the 6-character claim code from your agent to link it to your account.</p>
        <div class="claim-form">
          <input type="text" id="claim-code-input" placeholder="ABC123" maxlength="6">
          <button onclick="claimAgent()">Claim</button>
        </div>
        <div class="claim-result" id="claim-result"></div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Total Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-main">0</div>
          <div class="stat-label">Main Agents</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-workers">0</div>
          <div class="stat-label">Workers</div>
        </div>
      </div>

      <div class="table-card">
        <div class="table-header">
          <span class="table-title">Your Agents</span>
        </div>
        <table>
          <thead>
            <tr>
              <th>Agent</th>
              <th>DID</th>
              <th>Reputation</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="agents-tbody">
            <tr><td colspan="4"><div class="empty-state">Loading...</div></td></tr>
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://vlccvdskepntaskqniwm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsY2N2ZHNrZXBudGFza3FuaXdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgzNjQ0NzEsImV4cCI6MjA1Mzk0MDQ3MX0.2Zg9xCUDwD6Lg1w0zFdGU3dT5-ZTmYdPVGgOlZ6O8lI';
    const API = 'https://agent-identity.onrender.com';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentUser = null;
    let accessToken = null;

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.auth-tab:${tab === 'signin' ? 'first' : 'last'}-child`).classList.add('active');
      document.getElementById('signin-form').style.display = tab === 'signin' ? 'flex' : 'none';
      document.getElementById('signup-form').style.display = tab === 'signup' ? 'flex' : 'none';
      document.getElementById('auth-error').classList.remove('show');
    }

    function showError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg;
      el.classList.add('show');
    }

    async function handleSignIn(e) {
      e.preventDefault();
      const btn = document.getElementById('signin-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      
      if (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Sign In';
        return;
      }

      currentUser = data.user;
      accessToken = data.session.access_token;
      showDashboard();
    }

    async function handleSignUp(e) {
      e.preventDefault();
      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      const { data, error } = await supabase.auth.signUp({ email, password });
      
      if (error) {
        showError(error.message);
        btn.disabled = false;
        btn.textContent = 'Create Account';
        return;
      }

      if (data.user && !data.session) {
        showError('Check your email to confirm your account, then sign in.');
        btn.disabled = false;
        btn.textContent = 'Create Account';
        showAuthTab('signin');
        return;
      }

      currentUser = data.user;
      accessToken = data.session.access_token;
      showDashboard();
    }

    async function handleSignOut() {
      await supabase.auth.signOut();
      currentUser = null;
      accessToken = null;
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('dashboard').classList.remove('active');
    }

    function showDashboard() {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('dashboard').classList.add('active');
      document.getElementById('user-email').textContent = currentUser.email;
      loadMyAgents();
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('active');
    }

    function truncateDID(did) {
      if (!did) return '-';
      if (did.length <= 24) return did;
      return did.slice(0, 16) + '...' + did.slice(-6);
    }

    async function loadMyAgents() {
      const tbody = document.getElementById('agents-tbody');
      
      try {
        const res = await fetch(`${API}/agents/my`, {
          headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to load agents');
        }

        const data = await res.json();
        const agents = data.agents || [];
        
        // Flatten: main agents + their workers
        const allAgents = [];
        agents.forEach(main => {
          allAgents.push(main);
          if (main.workers) {
            main.workers.forEach(w => allAgents.push(w));
          }
        });

        // Stats
        document.getElementById('stat-total').textContent = data.total_agents || 0;
        document.getElementById('stat-main').textContent = agents.length;
        document.getElementById('stat-workers').textContent = (data.total_agents || 0) - agents.length;

        if (allAgents.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state">
            <p>No agents yet.</p>
            <p style="margin-top:0.5rem;font-size:0.85rem;">Use your agent's claim code to link it here.</p>
          </div></td></tr>`;
          return;
        }

        tbody.innerHTML = allAgents.map(agent => {
          const rep = agent.reputation || 3.0;
          const repPercent = (rep / 5) * 100;
          const type = agent.agent_type || agent.metadata?.agent_type || 'main';
          const isWorker = type === 'worker';
          
          return `
            <tr>
              <td>
                <div class="agent-cell">
                  <div class="agent-avatar">${isWorker ? 'üë§' : 'ü§ñ'}</div>
                  <span class="agent-name">${agent.name}</span>
                </div>
              </td>
              <td class="did-cell">${truncateDID(agent.did)}</td>
              <td>
                <div class="rep-cell">
                  <div class="rep-bar"><div class="rep-fill" style="width:${repPercent}%"></div></div>
                  <span>${rep.toFixed(1)}</span>
                </div>
              </td>
              <td><span class="status-badge ${type}">${type}</span></td>
            </tr>
          `;
        }).join('');

      } catch (e) {
        console.error('Load agents error:', e);
        tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state">Failed to load agents: ${e.message}</div></td></tr>`;
      }
    }

    async function claimAgent() {
      const code = document.getElementById('claim-code-input').value.trim().toUpperCase();
      const resultEl = document.getElementById('claim-result');
      
      if (!code || code.length !== 6) {
        resultEl.className = 'claim-result error';
        resultEl.textContent = 'Please enter a 6-character claim code.';
        return;
      }

      try {
        const res = await fetch(`${API}/agents/claim`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({ claim_code: code })
        });

        const data = await res.json();

        if (!res.ok) {
          resultEl.className = 'claim-result error';
          resultEl.textContent = data.error || data.message || 'Failed to claim agent';
          return;
        }

        resultEl.className = 'claim-result success';
        resultEl.textContent = `‚úÖ Claimed ${data.agent.name}! ${data.sub_agents_claimed > 0 ? `(+${data.sub_agents_claimed} sub-agents)` : ''}`;
        document.getElementById('claim-code-input').value = '';
        showToast('Agent claimed successfully!', 'success');
        loadMyAgents();

      } catch (e) {
        resultEl.className = 'claim-result error';
        resultEl.textContent = 'Network error. Please try again.';
      }
    }

    // Check for existing session on load
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session) {
        currentUser = session.user;
        accessToken = session.access_token;
        showDashboard();
      }

      // Listen for auth changes
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_OUT') {
          currentUser = null;
          accessToken = null;
          document.getElementById('auth-screen').classList.remove('hidden');
          document.getElementById('dashboard').classList.remove('active');
        }
      });
    }

    init();
  </script>
</body>
</html>
